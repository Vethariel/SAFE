{% extends 'base.html' %}
{% load static admin_extras %}

{% block title %}
  {{ course.name }} - SAFE Academy
{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'administration/css/course_detail.css' %}" />
{% endblock %}

{% block content %}
  <div class="container">
    <div class="breadcrumb">
      <a href="{% url 'admin_panel' %}?tab=cursos">‚Üê Volver a Administraci√≥n</a>
    </div>

    <div class="course-summary">
      <div class="course-header">
        <div class="course-header-content">
          <h1>{{ course.name }}</h1>
          <span class="status-badge status-{{ course.status }}">{{ course.get_status_display }}</span>
        </div>
        <div class="course-header-actions">
          <a href="{% url 'course_update' course.pk %}" class="btn-secondary">Editar Metadatos</a>
          <form method="post" action="{% url 'course_delete' course.pk %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn-danger" onclick="return confirm('¬øEliminar {{ course.name }}?')">Eliminar Curso</button>
          </form>
        </div>
      </div>

      <div class="info-card">
        <div class="info-row">
          <div class="info-item">
            <span class="info-label">Descripci√≥n</span>
            <p class="info-value">{{ course.description|default:'Sin descripci√≥n' }}</p>
          </div>
        </div>
        <div class="info-row">
          <div class="info-item">
            <span class="info-label">Duraci√≥n</span>
            <span class="info-value">{{ course.duration_hours|default:'--' }} horas</span>
          </div>
          <div class="info-item">
            <span class="info-label">M√≥dulos</span>
            <span class="info-value">{{ modules|length }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Creado por</span>
            <span class="info-value">{{ course.created_by.username|default:'--' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Fecha de creaci√≥n</span>
            <span class="info-value">{{ course.created_at|date:'d/m/Y' }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container course-body">
      <div class="course-layout" style="display: flex; flex-wrap: wrap; gap: 18px;">
        
        <section class="modules-panel" style="flex: 0 0 320px; max-width: 340px;">
          <div class="section-header">
            <h2 class="section-title">M√≥dulos</h2>
          </div>

          <div class="modules-list" id="modules-list">
            {% for module in modules %}
              <div class="module-card {% if selected_module and selected_module.pk == module.pk %}selected{% endif %}">
                <div class="module-header">
                  <a href="{% url 'course_detail' course.pk %}?module={{ module.pk }}" class="module-card-link" aria-label="Ver m√≥dulo {{ module.name }}">
                    <div class="module-info">
                      <h3 class="module-title">{{ forloop.counter }}. {{ module.name }}</h3>
                      <p class="module-description">{{ module.contents.count }} contenido(s)</p>
                    </div>
                  </a>
                  <div class="module-actions">
                    <div class="module-order-controls">
                      {% if not forloop.first %}
                        <form method="post" action="{% url 'module_move' module.pk 'up' %}">
                          {% csrf_token %}
                          <input type="hidden" name="next" value="{% url 'course_detail' course.pk %}?module={{ module.pk }}">
                          <button type="submit" class="order-btn" title="Mover arriba" aria-label="Mover m√≥dulo hacia arriba">&uarr;</button>
                        </form>
                      {% endif %}
                      {% if not forloop.last %}
                        <form method="post" action="{% url 'module_move' module.pk 'down' %}">
                          {% csrf_token %}
                          <input type="hidden" name="next" value="{% url 'course_detail' course.pk %}?module={{ module.pk }}">
                          <button type="submit" class="order-btn" title="Mover abajo" aria-label="Mover m√≥dulo hacia abajo">&darr;</button>
                        </form>
                      {% endif %}
                    </div>
                    <form method="post" action="{% url 'module_delete' module.pk %}" class="module-delete-form" onsubmit="return confirm('¬øEliminar {{ module.name }}?');">
                      {% csrf_token %}
                      <button type="submit" class="btn-danger module-delete-btn" aria-label="Eliminar m√≥dulo {{ module.name }}">X</button>
                    </form>
                  </div>
                </div>
              </div>
            {% empty %}
              <div class="empty-state-small">No hay m√≥dulos a√∫n.</div>
            {% endfor %}
          </div>

          <form method="post" action="{% url 'module_create' course.pk %}" class="inline-module-form">
            {% csrf_token %}
            {{ module_form.name }}
            <button type="submit" class="btn-primary" title="Agregar m√≥dulo">+</button>
          </form>

          <button type="button" id="toggleExamBtn" class="btn-primary" style="width: 100%; margin-top: 24px; display: flex; align-items: center; justify-content: center; gap: 8px;">
            <span>üìù</span> Crear Examen
          </button>
          </section>

        <div style="flex: 1 1 0; min-width: 0; display: flex; flex-direction: column; gap: 24px;">
          <!-- Contenidos Section -->  
          <section class="contents-panel" id="regularContentsPanel">
              <div class="section-header">
                <h2 class="section-title">Contenidos del m√≥dulo</h2>
              </div>

              {% if selected_module %}
                  <div class="content-columns">
                    <div class="content-carousel inline-editing">
                      <div class="carousel-header">
                        <p class="carousel-count">{{ module_contents|length }} bloque(s)</p>
                        <div class="carousel-controls">
                          <button type="button" class="btn btn-secondary" data-carousel-btn="prev">‚ñ≤</button>
                          <button type="button" class="btn btn-secondary" data-carousel-btn="next">‚ñº</button>
                        </div>
                      </div>
                      
                      <div class="content-notebook" id="content-notebook">
                        {% for content in module_contents %}
                          <article id="content-block-{{ content.pk }}" class="content-block content-block--{{ content.block_type }} {% if selected_content and selected_content.pk == content.pk %}is-active{% endif %}">
                            <div class="content-block__header">
                              <div>
                                <p class="content-block__order">Bloque {{ forloop.counter }}</p>
                                <h3 class="content-block__title">{{ content.title }}</h3>
                              </div>
                              <div class="content-block__tags">
                                <span class="content-type-pill">
                                  {% if content.block_type == 'text' %}Texto
                                  {% elif content.block_type == 'image' %}Imagen
                                  {% elif content.block_type == 'video' %}Video
                                  {% elif content.block_type == 'pdf' %}PDF
                                  {% elif content.block_type == 'quiz' %}Cuestionario
                                  {% else %}Contenido{% endif %}
                                </span>
                                {% if content.is_mandatory %}
                                  <span class="mandatory-chip">Obligatorio</span>
                                {% endif %}
                              </div>
                            </div>

                            <div class="content-block__body">
                              {% if content.block_type == 'text' %}
                                <div class="content-text">{{ content.description|linebreaks }}</div>
                              {% elif content.block_type == 'image' %}
                                {% if content.material and content.material.file %}
                                  <img src="{{ content.material.file.url }}" alt="{{ content.title }}" class="content-image" loading="lazy" />
                                {% else %}
                                  <p class="content-empty">Imagen no disponible.</p>
                                {% endif %}
                              {% elif content.block_type == 'video' %}
                                {% if content.material and content.material.file %}
                                  <video controls class="content-video">
                                    <source src="{{ content.material.file.url }}" type="video/{{ content.material.type|default:'mp4' }}" />
                                  </video>
                                {% else %}
                                  <p class="content-empty">Video no disponible.</p>
                                {% endif %}
                              {% elif content.block_type == 'pdf' %}
                                {% if content.material and content.material.file %}
                                  <a href="{{ content.material.file.url }}" target="_blank" rel="noopener" download class="download-button">
                                    <span class="download-icon">üìÑ</span>
                                    <span>{{ content.material.file.name|filename }}</span>
                                  </a>
                                {% else %}
                                  <p class="content-empty">Archivo PDF no disponible.</p>
                                {% endif %}
                              {% elif content.block_type == 'quiz' %}
                                {% if selected_content and selected_content.pk == content.pk %}
                                  <div class="quiz-edit-inline" id="quiz-editor-{{ content.pk }}">
                                    <div id="questions-container-inline"></div>
                                    <button type="button" class="btn-secondary-small" onclick="addQuestionInline()" style="margin-top: 16px;">+ Agregar pregunta</button>
                                  </div>
                                {% elif content.exam and content.exam.questions %}
                                    {% for question in content.exam.questions %}
                                      <div class="quiz-question-preview">
                                        <div class="question-preview-header">
                                          <h5>Pregunta {{ forloop.counter }}</h5>
                                          <small class="question-type-label">{% if question.type == 'single' %}Selecci√≥n √∫nica{% else %}Selecci√≥n m√∫ltiple{% endif %}</small>
                                        </div>
                                        <p class="question-text">{{ question.text }}</p>
                                        <div class="answers-preview">
                                          {% for answer in question.answers %}
                                            <div class="answer-preview {% if answer.is_correct %}correct-answer{% endif %}">
                                              <span class="answer-marker">{% if answer.is_correct %}‚úì{% else %}‚óã{% endif %}</span>
                                              <span>{{ answer.text }}</span>
                                            </div>
                                          {% endfor %}
                                        </div>
                                      </div>
                                    {% endfor %}
                                {% else %}
                                  <p class="content-empty">Crea un cuestionario para este bloque.</p>
                                {% endif %}
                              {% endif %}
                        </div>

                        <div class="content-block__actions">
                          <div class="content-order-controls">
                            {% if not forloop.first %}
                              <form method="post" action="{% url 'content_move' content.pk 'up' %}">
                                {% csrf_token %}
                                <input type="hidden" name="next" value="{% url 'course_detail' course.pk %}?module={{ selected_module.pk }}&content={{ content.pk }}#content-block-{{ content.pk }}">
                                <button type="submit" class="order-btn" title="Mover arriba" aria-label="Mover contenido hacia arriba">&uarr;</button>
                              </form>
                            {% endif %}
                            {% if not forloop.last %}
                              <form method="post" action="{% url 'content_move' content.pk 'down' %}">
                                {% csrf_token %}
                                <input type="hidden" name="next" value="{% url 'course_detail' course.pk %}?module={{ selected_module.pk }}&content={{ content.pk }}#content-block-{{ content.pk }}">
                                <button type="submit" class="order-btn" title="Mover abajo" aria-label="Mover contenido hacia abajo">&darr;</button>
                              </form>
                            {% endif %}
                          </div>
                          <div class="content-block__actions-edit">
                            {% if selected_content and selected_content.pk == content.pk and content_edit_form %}
                              <a href="{% url 'course_detail' course.pk %}?module={{ selected_module.pk }}#content-block-{{ content.pk }}" class="btn-tertiary btn-small">Cerrar</a>
                            {% else %}
                              <a href="{% url 'course_detail' course.pk %}?module={{ selected_module.pk }}&content={{ content.pk }}#content-block-{{ content.pk }}" class="btn-secondary btn-small">Editar</a>
                            {% endif %}
                          </div>
                        </div>

                            {% if selected_content and selected_content.pk == content.pk and content_edit_form %}
                               <form id="delete-form-{{ selected_content.pk }}" method="post" action="{% url 'content_delete' selected_content.pk %}" style="display: none;">{% csrf_token %}</form>
                            {% endif %}
                          </article>
                        {% empty %}
                          <div class="empty-state-small">No hay contenidos en este m√≥dulo.</div>
                        {% endfor %}

                        {% if not selected_content %}
                          <div class="add-content-wrapper">
                            {% if module_contents %}
                              <button type="button" class="btn-primary add-content-toggle" data-create-toggle>+ Agregar contenido</button>
                              <article class="content-block content-block--new is-collapsed" id="content-block-new" data-create-panel>
                            {% else %}
                              <h4 class="inspector-subtitle" style="margin-bottom: 16px;">Agregar el primer bloque</h4>
                              <article class="content-block content-block--new" id="content-block-new" data-create-panel>
                            {% endif %}
                              <div class="content-block__header">
                                <div>
                                  <p class="content-block__order">{% if module_contents %}Nuevo bloque{% else %}Bloque 1{% endif %}</p>
                                  <h3 class="content-block__title">Formulario de creaci√≥n</h3>
                                </div>
                              </div>
                              <form method="post" enctype="multipart/form-data" action="{% url 'content_create' selected_module.pk %}" class="content-form inline-editor" data-create-form>
                                {% csrf_token %}
                                <div class="form-grid">
                                  <div class="form-field form-field-title">
                                    <label>T√≠tulo</label>
                                    {{ content_form.title }}
                                  </div>
                                  <div class="form-field form-field-type">
                                    <label>Tipo de bloque</label>
                                    {% if selected_module and selected_module.name|lower == 'examen' %}
                                      <div class="chip chip-static">Cuestionario</div>
                                      <input type="hidden" name="block_type" value="quiz">
                                    {% else %}
                                      {{ content_form.block_type }}
                                    {% endif %}
                                  </div>
                                  <div class="form-field checkbox-field form-field-inline">
                                    <label class="checkbox-label">{{ content_form.is_mandatory }} <span>Obligatorio</span></label>
                                  </div>
                                  <div class="form-field form-field-full">
                                    <label>Texto</label>
                                    {{ content_form.description }}
                                  </div>
                                  {% if not selected_module or selected_module.name|lower != 'examen' %}
                                    <div class="form-field form-field-full file-field" data-file-field>
                                      <label>Archivo (imagen/video/pdf)</label>
                                      {{ material_form.expected_type }}
                                      <div class="file-input-wrapper">{{ material_form.file }}</div>
                                      <small class="field-hint">El tipo se determina autom√°ticamente.</small>
                                    </div>
                                  {% endif %}
                                  <div class="form-field form-field-full quiz-editor" data-quiz-editor style="display: {% if selected_module and selected_module.name|lower == 'examen' %}block{% else %}none{% endif %};">
                                    <label>Preguntas del cuestionario</label>
                                    <div id="questions-container"></div>
                                    <button type="button" class="btn-secondary" onclick="addQuestion()">+ Agregar pregunta</button>
                                    <input type="hidden" name="quiz_questions" id="quiz_questions" value="[]">
                                  </div>
                                </div>
                                <div class="content-form__actions">
                                  <button type="submit" class="btn-primary">{% if module_contents %}Crear bloque{% else %}Agregar contenido{% endif %}</button>
                                </div>
                              </form>
                            </article>
                          </div>
                        {% endif %}
                      </div>
                    </div>
                  </div>

              {% else %}
                <div class="empty-state-small" style="margin-bottom: 0;">
                    Selecciona un m√≥dulo a la izquierda para ver sus contenidos.
                </div>
              {% endif %}
           </section>
                 
              <!-- Crear Examen Section -->
            <section id="examFormContainer" class="create-exam-panel" style="display: none; background: var(--safe-card); border: 1px solid var(--safe-border); border-radius: 18px; padding: 24px;">
                
                <div class="section-header" style="margin-bottom: 20px;">
                  <h2 class="section-title" style="font-size: 20px; font-weight: 600; color: var(--safe-dark);">Crear Examen</h2>
                </div>

                <div class="exam-mode-buttons">
                  <button type="button" class="exam-mode-btn is-active" data-exam-mode-target="upload">Crear examen con TXT</button>
                  <button type="button" class="exam-mode-btn" data-exam-mode-target="manual">Crear examen manualmente</button>
                </div>

                <div class="exam-mode-panel is-active" data-exam-mode="upload">
                  <form method="post" enctype="multipart/form-data" action="{% url 'create_exam_for_course' course.pk %}" class="content-form">
                    {% csrf_token %}
                    
                    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                      <div class="form-field" style="grid-column: 1 / 2;">
                        <label class="label" style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">T√≠tulo del Examen</label>
                        <input type="text" name="title" required placeholder="Ej. Evaluaci√≥n Final" style="width: 100%; padding: 10px 12px; border: 1px solid var(--safe-border); border-radius: 10px; font-size: 14px;">
                      </div>

                      <div class="form-field" style="grid-column: 2 / 3;">
                        <label class="label" style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Nivel de Dificultad</label>
                        <select name="difficulty" style="width: 100%; padding: 10px 12px; border: 1px solid var(--safe-border); border-radius: 10px; font-size: 14px;">
                          <option value="facil">F√°cil</option>
                          <option value="media" selected>Media</option>
                          <option value="dificil">Dif√≠cil</option>
                        </select>
                      </div>

                      <div class="form-field form-field-full" style="grid-column: 1 / -1; margin-top: 16px;">
                        <label class="label" style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Archivo de preguntas (.txt)</label>
                        <small class="field-hint">Formato: l√≠neas con <code>Q:ID|Texto</code> y <code>O:ID|Texto|1/0</code>.</small>
                        
                        <input type="file" name="file" id="exam-file-input" accept=".txt" style="display: none;" onchange="updateFileName(this)">
                        
                        <label for="exam-file-input" class="drop-zone" id="exam-drop-zone" style="background: #fff; border: 2px dashed var(--safe-border); border-radius: 14px; padding: 30px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: all 0.2s;">
                          <div class="drop-zone-icon" style="font-size: 32px; margin-bottom: 8px;">üìÑ</div>
                          <span id="file-name-text" style="color: var(--safe-ink2); font-size: 14px;">
                            Arrastra tu archivo <strong>.txt</strong> aqu√≠ o haz clic para buscar
                          </span>
                          <button type="button" class="btn-secondary btn-small" style="margin-top: 12px; pointer-events: none; background: var(--safe-card-alt); color: var(--safe-dark); border: 1px solid var(--safe-border); border-radius: 10px; padding: 6px 12px; font-weight: 600; font-size: 13px;">
                            Seleccionar archivo
                          </button>
                        </label>
                      </div>
                    </div>

                    <div class="content-form__actions" style="display: flex; justify-content: flex-end; margin-top: 24px;">
                      <button type="submit" class="btn-primary" style="background: var(--safe-gold); color: var(--safe-dark); border: none; border-radius: 10px; padding: 10px 16px; font-weight: 600; cursor: pointer; width: 100%; max-width: 200px;">Crear examen</button>
                    </div>
                  </form>
                </div>

                <div class="exam-mode-panel" data-exam-mode="manual">
                   <div class="empty-state-small">Funcionalidad manual en construcci√≥n...</div>
                </div>
            </section>

        </div>
      </div>
<!-- Fin Crear Examen Section -->
  <div id="jsFeedbackModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content feedback-content">
      <div class="feedback-icon icon-warning">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
      </div>
      <h3 class="feedback-title">Atenci√≥n</h3>
      <p class="feedback-text" id="jsFeedbackText">Mensaje por defecto</p>
      <button type="button" class="btn btn-primary btn-wide" onclick="closeJsModal()">Aceptar</button>
    </div>
  </div>

  <div id="delete-modal" class="confirm-overlay" style="display:none;">
    <div class="confirm-card">
      <div class="warning-icon">‚ö†Ô∏è</div>
      <h1 class="confirm-title">¬øEliminar?</h1>
      <div id="delete-entity-info" class="course-info">
        <h2 id="delete-entity-name" class="course-name"></h2>
        <div id="delete-entity-meta" class="course-meta"></div>
      </div>
      <div class="warning-box">
        <strong>‚ö†Ô∏è Esta acci√≥n no se puede deshacer</strong>
        <p>Al eliminar esto, se eliminar√°n todos los elementos asociados.</p>
      </div>
      <form id="delete-form" method="post" action="">
        {% csrf_token %}
        <div class="form-actions">
          <button type="button" id="delete-cancel" class="btn-secondary">‚Üê Cancelar</button>
          <button type="submit" class="btn-danger">üóëÔ∏è S√≠, eliminar</button>
        </div>
      </form>
    </div>
  </div>

  </div>
  <div id="jsFeedbackModal" class="modal-backdrop" style="display: none;">
  <div class="modal-content feedback-content">
    
    <div class="feedback-icon icon-warning">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
    </div>

    <h3 class="feedback-title">Atenci√≥n</h3>
    <p class="feedback-text" id="jsFeedbackText">Mensaje por defecto</p>

    <button type="button" class="btn btn-primary btn-wide" onclick="closeJsModal()">
      Aceptar
    </button>

  </div>
</div>
{% endblock %}

