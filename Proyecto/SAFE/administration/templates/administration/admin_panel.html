{% extends 'base.html' %}
{% load static %}

{% block title %}
  Administración — SAFE
{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'administration/css/admin_panel.css' %}" />
{% endblock %}

{% block content %}
  <div class="admin-container">
    <h1 class="admin-title">Administración</h1>

    <div class="admin-tabs">
      <a href="?tab=usuarios" class="admin-tab {% if active_tab == 'usuarios' %}active{% endif %}">Usuarios</a>
      <a href="?tab=cursos" class="admin-tab {% if active_tab == 'cursos' %}active{% endif %}">Cursos</a>
      <a href="?tab=rutas" class="admin-tab {% if active_tab == 'rutas' %}active{% endif %}">Rutas</a>
      <a href="?tab=equipos" class="admin-tab {% if active_tab == 'equipos' %}active{% endif %}">Equipos</a>
    </div>

    <!-- USUARIOS -->
    {% if active_tab == 'usuarios' %}
      <div class="card-panel">
        <div class="panel-header">
          <h2 class="panel-title">Gestión de usuarios</h2>
          <button type="button" class="btn btn-gold" onclick="document.getElementById('createUserModal').style.display='flex'">Nuevo usuario</button>
        </div>

        <div class="table-responsive">
          <table class="table-custom">
            <thead>
              <tr>
                <th class="th-name">Nombre/s</th>

                <th class="th-name">Apellido/s</th>

                <th class="th-name">Username</th>

                <th class="th-email">Email</th>
                <th class="th-role">Rol</th>
                <th class="th-status">Estado</th>
                <th class="th-actions text-right">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for u in usuarios %}
                <tr>
                  <td class="font-weight-medium">{{ u.first_name|default:'-' }}</td>

                  <td class="font-weight-medium">{{ u.last_name|default:'-' }}</td>

                  <td class="text-muted">{{ u.username }}</td>

                  <td class="text-muted">{{ u.email }}</td>

                  <td>
                    <form method="post" action="{% url 'user_update_role' u.id %}">
                      {% csrf_token %}
                      <select name="role" class="role-select" onchange="this.form.submit()">
                        {% if u.role == 'colaborador' %}
                          <option value="colaborador" selected>Colaborador</option>
                        {% else %}
                          <option value="colaborador">Colaborador</option>
                        {% endif %}

                        {% if u.role == 'supervisor' %}
                          <option value="supervisor" selected>Supervisor</option>
                        {% else %}
                          <option value="supervisor">Supervisor</option>
                        {% endif %}

                        {% if u.role == 'analistaTH' %}
                          <option value="analistaTH" selected>Analista TH</option>
                        {% else %}
                          <option value="analistaTH">Analista TH</option>
                        {% endif %}
                      </select>
                    </form>
                  </td>

                  <td>
                    <span class="status-badge status-{{ u.status }}">{{ u.get_status_display }}</span>
                  </td>

                  <td class="text-right">
                    <div class="actions-group">
                      <form method="post" action="{% url 'user_toggle_status' u.id %}" style="display:inline;">
                        {% csrf_token %}
                        {% if u.status == 'active' %}
                          <button type="submit" class="action-link text-danger" title="Desactivar usuario">Desactivar</button>
                        {% else %}
                          <button type="submit" class="action-link text-success" title="Activar usuario">Activar</button>
                        {% endif %}
                      </form>

                      <button type="button" class="action-link text-primary" onclick="openEnrollModal('{{ u.id }}', '{{ u.username }}')">Inscribir a curso</button>
                    </div>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="7" class="empty-state">No hay usuarios registrados.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}

    <!-- CURSOS -->
    {% if active_tab == 'cursos' %}
      <div class="section-header">
        <h2>Cursos disponibles</h2>
        <a href="{% url 'course_create' %}" class="btn-primary">Nuevo</a>
      </div>

      {% if courses %}
        <div class="courses-grid">
          {% for course in courses %}
            <div class="course-card">
              <div class="course-header">
                <!-- Aca poner el renderizado de la imagen -->
              </div>
              <div class="course-body">
                <div class="course-title-row">
                  <h3>{{ course.name }}</h3>
                  <span class="badge badge-{{ course.status }}">{{ course.get_status_display }}</span>
                </div>
                <p class="course-description">{{ course.description|default:'Sin descripción' }}</p>
                <div class="course-meta">
                  <span>{{ course.duration_hours|default:'--' }}h</span>
                  <span>{{ course.modules.count }} módulos</span>
                </div>
                <div class="course-actions">
                  <a href="{% url 'course_detail' course.pk %}" class="btn-secondary">Ver</a>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-state">
          <p>No hay cursos creados</p>
          <a href="{% url 'course_create' %}" class="btn-primary">Crear primer curso</a>
        </div>
      {% endif %}
    {% endif %}

    <!-- RUTAS -->
    {% if active_tab == 'rutas' %}
      <div class="section-header">
        <h2>Rutas de aprendizaje</h2>
        <a href="{% url 'path_create' %}" class="btn-primary">Nueva ruta</a>
      </div>

      {% if learning_paths %}
        <div class="courses-grid">
          {% for path in learning_paths %}
            <div class="course-card">
              <div class="course-body">
                <div class="course-title-row">
                  <h3>{{ path.name }}</h3>
                  <span class="badge badge-{{ path.status }}">{{ path.get_status_display }}</span>
                </div>
                <p class="course-description">{{ path.description|default:'Sin descripción' }}</p>
                <div class="course-meta">
                  <span>{{ path.estimated_duration|default:'--' }}h</span>
                  <span>{{ path.courses.count }} cursos</span>
                </div>
                <div class="course-actions">
                  <a href="{% url 'path_detail' path.pk %}" class="btn-secondary">Ver</a>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-state">
          <p>No hay rutas creadas</p>
          <a href="{% url 'path_create' %}" class="btn-primary">Crear primer ruta</a>
        </div>
      {% endif %}
    {% endif %}

    <!-- EQUIPOS -->
    {% if active_tab == 'equipos' %}
      <div class="card-panel">
        <div class="panel-header">
          <h2 class="panel-title">Gestión de Equipos</h2>
          <button type="button" class="btn btn-gold" onclick="openCreateTeamModal()">Nuevo Equipo</button>
        </div>

        <div class="table-responsive">
          <table class="table-custom">
            <thead>
              <tr>
                <th class="th-name">Nombre</th>
                <th class="th-name">Supervisor</th>
                <th class="th-status">Miembros</th>
                <th class="th-actions text-right">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for team in teams %}
                <tr>
                  <td class="font-weight-medium">{{ team.name }}</td>
                  <td>
                    {% if team.supervisor %}
                      {{ team.supervisor.first_name }} {{ team.supervisor.last_name }}
                    {% else %}
                      <span class="text-muted">Sin asignar</span>
                    {% endif %}
                  </td>
                  <td>{{ team.members.count }}</td>
                  <td class="text-right">
                    <div class="actions-group">
                      <button class="action-link text-primary" data-team-id="{{ team.id }}" data-team-name="{{ team.name }}" data-url="{% url 'team_add_member' team.id %}" onclick="openManageMembersModal(this)">Miembros</button>
                      <button class="action-link text-primary" data-team-id="{{ team.id }}" data-team-name="{{ team.name }}" data-team-desc="{{ team.description }}" data-team-sup="{{ team.supervisor.id }}" data-url="{% url 'team_update' team.id %}" onclick="openEditTeamModal(this)">Editar</button>
                      <form method="post" action="{% url 'team_delete' team.id %}" style="display:inline;" onsubmit="return confirm('¿Estás seguro de eliminar este equipo?');">
                        {% csrf_token %}
                        <button type="submit" class="action-link text-danger">Eliminar</button>
                      </form>
                    </div>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="4" class="text-center" style="padding: 2rem; color: #6b7280;">No hay equipos creados.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}
  </div>
  <!-- MODAL PARA INSCRIBIR A CURSO -->
  <div id="enrollModal" class="modal-backdrop">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Inscribir colaborador a curso</h3>
        <span class="close-modal" onclick="closeEnrollModal()">&times;</span>
      </div>

      <form method="post" action="{% url 'enroll_user' %}">
        {% csrf_token %}

        <input type="hidden" name="user_id" id="modalUserId" />

        <div class="modal-body">
          <label for="courseSelect" class="label">Curso</label>
          <select name="course_id" id="courseSelect" class="input" required>
            <option value="" disabled selected>Selecciona un curso</option>
            {% for course in courses %}
              {% if course.status == 'active' %}
                <option value="{{ course.id }}">{{ course.name }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="closeEnrollModal()">Cancelar</button>
          <button type="submit" class="btn btn-gold">Inscribir</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Team Modal -->
  <div id="createTeamModal" class="modal-backdrop">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Crear Equipo</h3>
        <span class="close-modal" onclick="closeCreateTeamModal()">&times;</span>
      </div>
      <form method="post" action="{% url 'team_create' %}">
        {% csrf_token %}
        <div class="modal-body">
          <label class="label">Nombre</label>
          <input type="text" name="name" class="input" required />
          <div style="margin-top: 10px;">
            <label class="label">Descripción</label>
            <textarea name="description" class="input"></textarea>
          </div>
          <div style="margin-top: 10px;">
            <label class="label">Supervisor</label>
            <select name="supervisor_id" class="input">
              <option value="">-- Seleccionar --</option>
              {% for sup in supervisors %}
                <option value="{{ sup.id }}">{{ sup.first_name }} {{ sup.last_name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="closeCreateTeamModal()">Cancelar</button>
          <button type="submit" class="btn btn-gold">Crear</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Team Modal -->
  <div id="editTeamModal" class="modal-backdrop">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Editar Equipo</h3>
        <span class="close-modal" onclick="closeEditTeamModal()">&times;</span>
      </div>
      <form method="post" id="editTeamForm" action="">
        {% csrf_token %}
        <div class="modal-body">
          <label class="label">Nombre</label>
          <input type="text" name="name" id="editTeamName" class="input" required />
          <div style="margin-top: 10px;">
            <label class="label">Descripción</label>
            <textarea name="description" id="editTeamDescription" class="input"></textarea>
          </div>
          <div style="margin-top: 10px;">
            <label class="label">Supervisor</label>
            <select name="supervisor_id" id="editTeamSupervisor" class="input">
              <option value="">-- Seleccionar --</option>
              {% for sup in supervisors %}
                <option value="{{ sup.id }}">{{ sup.first_name }} {{ sup.last_name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="closeEditTeamModal()">Cancelar</button>
          <button type="submit" class="btn btn-gold">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Manage Members Modal -->
  <div id="manageMembersModal" class="modal-backdrop">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 id="manageMembersTitle">Miembros del Equipo</h3>
        <span class="close-modal" onclick="closeManageMembersModal()">&times;</span>
      </div>
      <div class="modal-body">
        <!-- Add Member Form -->
        <form method="post" id="addMemberForm" action="" style="margin-bottom: 20px; display: flex; gap: 10px;">
          {% csrf_token %}
          <select name="user_id" class="input" required style="flex: 1;">
            <option value="">-- Añadir usuario --</option>
            {% for u in usuarios %}
              <option value="{{ u.id }}">{{ u.first_name }} {{ u.last_name }} ({{ u.username }})</option>
            {% endfor %}
          </select>
          <button type="submit" class="btn btn-gold">Añadir</button>
        </form>

        <!-- Members List -->
        <div id="membersListContainer">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden Data for Members -->
  {% for team in teams %}
    <div id="team-members-{{ team.id }}" style="display:none;">
      <table class="table-custom" style="width: 100%;">
        {% for member in team.members.all %}
          <tr>
            <td>{{ member.app_user.first_name }} {{ member.app_user.last_name }}</td>
            <td class="text-right">
              <form method="post" action="{% url 'team_remove_member' team.id member.app_user.id %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="text-danger" onclick="return confirm('¿Eliminar miembro?')">&times;</button>
              </form>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="2" class="text-muted">Sin miembros</td>
          </tr>
        {% endfor %}
      </table>
    </div>
  {% endfor %}

  <script src="{% static 'administration/js/admin_panel.js' %}"></script>

  <!-- ================= MODAL DE MENSAJES (FEEDBACK) ================= -->
  {% if messages %}
    <div id="feedbackModal" class="modal-backdrop" style="display: flex;">
      <div class="modal-content feedback-content">
        {% for message in messages %}
          <!-- Icono Dinámico -->
          <div class="feedback-icon {% if message.tags == 'success' %}
              
              
              
              icon-success



            {% else %}
              
              
              
              icon-warning



            {% endif %}">
            {% if message.tags == 'success' %}
              <!-- Chulito Verde (SVG) -->
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            {% else %}
              <!-- Signo de Exclamación (SVG) -->
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
            {% endif %}
          </div>

          <!-- Título y Texto -->
          <h3 class="feedback-title">
            {% if message.tags == 'success' %}
              ¡Excelente!
            {% else %}
              Atención
            {% endif %}
          </h3>
          <p class="feedback-text">{{ message }}</p>

          <!-- Botón Aceptar -->
          <button type="button" class="btn btn-gold btn-wide" onclick="document.getElementById('feedbackModal').style.display='none'">Aceptar</button>
        {% endfor %}
      </div>
    </div>
  {% endif %}
  <!-- Crear Usuario -->
  <div id="createUserModal" class="modal-backdrop">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Crear usuario</h3>
        <span class="close-modal" onclick="document.getElementById('createUserModal').style.display='none'">&times;</span>
      </div>

      <form method="post" action="{% url 'admin_create_user' %}">
        {% csrf_token %}

        <div class="modal-body">
          <label class="label">Username</label>
          <input type="text" name="username" class="input" required placeholder="ej. juanperez" />

          <div style="display: flex; gap: 10px; margin-top: 10px;">
            <div style="flex: 1;">
              <label class="label">Nombre/s</label>
              <input type="text" name="first_name" class="input" required placeholder="Juan" />
            </div>
            <div style="flex: 1;">
              <label class="label">Apellido/s</label>
              <input type="text" name="last_name" class="input" required placeholder="Pérez" />
            </div>
          </div>

          <div style="margin-top: 10px;">
            <label class="label">Correo electrónico</label>
            <input type="email" name="email" class="input" required placeholder="correo@empresa.com" />
          </div>

          <div style="margin-top: 10px;">
            <label class="label">Rol</label>
            <select name="role" class="input">
              <option value="colaborador">Colaborador</option>
              <option value="analistaTH">Analista TH</option>
              <option value="supervisor">Supervisor</option>
            </select>
          </div>

          <div style="display: flex; gap: 10px; margin-top: 10px;">
            <div style="flex: 1;">
              <label class="label">Contraseña</label>
              <input type="password" name="password" class="input" required placeholder="********" />
            </div>
            <div style="flex: 1;">
              <label class="label">Confirmar</label>
              <input type="password" name="confirm_password" class="input" required placeholder="********" />
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="document.getElementById('createUserModal').style.display='none'">Cancelar</button>
          <button type="submit" class="btn btn-gold">Crear</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}
